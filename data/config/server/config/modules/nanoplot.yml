- name: nanoplot
  title: "Nanoplot"
  icon: "chart-area"
  version: 1.0
  basestack_released: 2.0
  module: True
  schema_version: 1
  url: https://github.com/wdecoster/NanoPlot
  description: "Run plotting metrics  based on a a Nanopore reads run directory"
  tooltip: "Run Pairwise distance estimation on 2 genomes"
  tags: 
    - "Plotting"
    - "nanopore"
    - "statistics"
    - "graphing"
  procedures: 
    - name: nanoplot #Top level is the left-hand selection of the menu and the major module to install 
      title: "Nanoplot" 
      icon: "chart-area"
      module: True
      init: false 
      dependencies:
        - target: "nanozoo/nanoplot"
          label: "nanozoo/nanoplot"
          type: "docker"
          version: "1.42.0--547049c"
          format: "docker"
        - source: 
            url: "https://raw.githubusercontent.com/wdecoster/NanoPlot/master/scripts/add_barcodes_to_summary.py"
            type: "file"
            remove: true
            target: "${writePath}/workflows/nanoplot/add_barcodes_to_summary.py"
          type: "download" 
          format: "file"
          label: "Nanoplot Merge Barcode Script"
          target: "${writePath}/workflows/nanoplot/add_barcodes_to_summary.py"
          overwrite: true 
      tags: 
        - "Sequencing Plot"
        - "ONT Statistics"
      services:
        - name: nanoplot
          label: "Nanoplot"
          image: "nanozoo/nanoplot:1.42.0--547049c"
          workingdir: "/opt/databases"
          orchestrated: false #orchestrated means it r
          init: false
          force_restart: false
          bind:
            - from: "${writePath}/workflows/nanoplot"
              to: /opt/scripts
          force_init: false
          command: ["bash","-c", " NanoPlot -o $outdir  "]
      removal_override: 
        source: "<<directory(%{variables.input.source})>>/NanoPlot"
        type: "dir"
      variables:
        input:
          label: "Input File"
          option: 0
          options:
            - element: "file"
              hint: "Select your sequencing summary file output from basecalling from Guppy. Generated alongside fastq_pass"
              name: "Sequencing Summary File"
              bind_parent_dir: true
              bind:  
                from: "<<directory(%{variables.input.source})>>"
                to: "/opt/data"
              source: null
              target: "/opt/data/<<basename(%{variables.input.source})>>"
              define:
                outdir: "<<directory(%{variables.input.target})>>/NanoPlot"  
              append:
                command: " --summary ${input} "
                placement: 2
                services: 
                  - 0
            - name: "Fasta file"
              hint: "Data is in one or more default fasta file(s)."
              bind_parent_dir: true
              element: "file"
              bind: 
                from: "<<directory(%{variables.input.source})>>"
                to: "/opt/data"
              class: "wb-100  p-3 mb-1"
              source: null
              target: "/opt/data/<<basename(%{variables.input.source})>>"
              define:
                outdir: "<<directory(%{variables.input.target})>>/NanoPlot"  
              append:
                command: " --fasta ${input} "
                placement: 2
                services: 
                  - 0
            - name: "Fastq Rich file"
              hint: "Data is in one or more fastq file(s) generated by albacore or MinKNOW with additional information concerning channel and time."
              bind_parent_dir: true
              element: "file"
              bind: 
                from: "<<directory(%{variables.input.source})>>"
                to: "/opt/data"
              class: "wb-100  p-3 mb-1"
              source: null
              target: "/opt/data/<<basename(%{variables.input.source})>>"
              define:
                outdir: "<<directory(%{variables.input.target})>>/NanoPlot"  
              append:
                command: " --fastq_rich ${input} "
                placement: 2
                services: 
                  - 0
            - name: "Fastq file"
              hint: "Data is in one or more default fastq file(s)."
              bind_parent_dir: true
              element: "file"
              bind: 
                from: "<<directory(%{variables.input.source})>>"
                to: "/opt/data"
              class: "wb-100  p-3 mb-1"
              target: "/opt/data/<<basename(%{variables.input.source})>>"
              append:
                command: " --fastq ${input} "
                placement: 2
                services: 
                  - 0
              define:
                outdir: "<<directory(%{variables.input.target})>>/NanoPlot"  
              source: null
            - name: "Fastq minimal file"
              hint: "Data is in one or more fastq file(s) generated by albacore or MinKNOW with
                        additional information concerning channel and time. Minimal data is extracted
                        swiftly without elaborate checks."
              bind_parent_dir: true
              element: "file"
              bind: 
                from: "<<directory(%{variables.input.source})>>"
                to: "/opt/data"
              class: "wb-100  p-3 mb-1"
              source: null
              define:
                outdir: "<<directory(%{variables.input.target})>>/NanoPlot"  
              target: "/opt/data/<<basename(%{variables.input.source})>>"
              append:
                command: " --fastq_minimal ${input} "
                placement: 2
                services: 
                  - 0
            - name: "BAM file"
              hint: "Data is in one or more sorted bam file(s)."
              bind_parent_dir: true
              element: "file"
              bind: 
                from: "<<directory(%{variables.input.source})>>"
                to: "/opt/data"
              class: "wb-100  p-3 mb-1"
              source: null
              target: "/opt/data/<<basename(%{variables.input.source})>>"
              define:
                outdir: "<<directory(%{variables.input.target})>>/NanoPlot"  
              append:
                command: " --bam ${input} "
                placement: 2
                services: 
                  - 0  
            - name: "Unaligned BAM file"
              hint: "Data is in one or more sorted bam file(s)."
              bind_parent_dir: true
              element: "file"
              bind: 
                from: "<<directory(%{variables.input.source})>>"
                to: "/opt/data"
              class: "wb-100  p-3 mb-1"
              source: null
              target: "/opt/data/<<basename(%{variables.input.source})>>"
              define:
                outdir: "<<directory(%{variables.input.target})>>/NanoPlot"  
              append:
                command: " --ubam ${input} "
                placement: 2
                services: 
                  - 0   
        output:
          label: "Output Plots"
          element: "file"
          output: True
          openSelf: True
          hint: "Set of ONT plots for your input"
          bind_parent_dir: true
          class: "wb-100  p-3 mb-1"
          source: "<<directory(%{variables.input.source})>>/NanoPlot/NanoPlot-report.html"
          target: null
        barcoded:
          label: "Split plots by barcodes "
          bind_parent_dir: true
          hint: "Only select if using sequencing summary file"
          element: "file"
          source: false
          bind: 
            from: "<<directory(%{variables.barcoded.source})>>"
            to: "/opt/barcode"
          target: "/opt/barcode/<<basename(%{variables.barcoded.source})>>"
          optional: true
          append:
            - command: " awk -F '\\t' '{ if ($10 != \"FALSE\" && 10 != \"False\" ) {print $0}}'  ${input} > /opt/sequencing_summary.txt; python3 /opt/scripts/add_barcodes_to_summary.py /opt/sequencing_summary.txt  ${barcoded} && input=/opt/databases/barcoded_sequencing_summary.txt.gz &&   "
              placement: 2
              position: "start"
              services: 
                - 0
            - command: " --barcoded "
              placement: 2
              services: 
                - 0

        
      
    
