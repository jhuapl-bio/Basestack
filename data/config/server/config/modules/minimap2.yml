- name: minimap2
  title: "Minimap2"
  icon: "magic"
  version: 1.0
  basestack_released: 2.0
  module: True
  tags: 
    - "minimap2"
    - "alignment"
    - "genomics"
  tooltip: "Run Minimap2 Alignment on Fastq Files against database files"
  shared:
    variables:
      sam:
        label: "Alignment File"
        hint: "Alignment file to be used in downstream analysis"
        watch: True
        output: True
        openSelf: True
        element: "file"
        source: "%{variables.file.source}.sam" 
        target: "%{variables.bam.bind.to}/<<basename,trim(%{variables.sam.source})>>.sam"
      bam:
        label: "BAM File"
        element: "file"
        hint: "Compressed BAM file from SAM format"
        bind_parent_dir: true
        output: True
        bind: 
          from: "%{variables.bam.source}"
          to: "/opt/data"
        class: "wb-100  p-3 mb-1"
        source: "<<directory(%{variables.sam.bind.from})>>/<<basename,trim(%{variables.sam.source})>>.bam"
        target: "%{variables.bam.bind.to}/<<basename,trim(%{variables.sam.source})>>.bam"
      bai:
        label: "BAI File"
        hint: "BAI index file generated from an alignment and sorted"
        watch: True
        output: True
        element: "file"
        source: "<<directory(%{variables.bam.bind.from})>>/<<basename(%{variables.bam.source})>>.bai"
        target: "%{variables.bam.bind.to}/<<basename(%{variables.bam.source})>>.bai"
  procedures:
    - name: minimap2 #Top level is the left-hand selection of the menu and the major module to install 
      title: "Minimap2"
      icon: "magic"
      module: True
      init: false 
      dependencies:
        - target: "staphb/minimap2"
          type: "docker"
          format: "docker"
        - target: "staphb/samtools"
          type: "docker"
          format: "docker"
      tags: 
        - "minimap2"
        - "alignment"
        - "genomics"
      variables:
        file:
          label: "FASTA/Q File"
          element: "file"
          bind_parent_dir: true
          bind: 
            from: "%{variables.file.source}"
            to: "/opt/data"
          class: "wb-100  p-3 mb-1"
          source: null
          target: "%{variables.file.bind.to}/%{variables.file.source}"
        ref:
          label: "Reference to align against"
          class: "wb-100 p-3 mb-1"
          hint: "Must be in FASTA format. This is the genome you want to align your sequences against"
          element: "file" 
          bind_parent_dir: true
          bind: 
            from: "%{variables.ref.source}"
            to: "/opt/ref"
          source: null
          target: "%{variables.ref.bind.to}/%{variables.ref.source}"
        bam: 
          target: "%{shared.variables.bam}"
          shared: true
        sam: 
          target: "%{shared.variables.sam}"
          shared: true
        bai: 
          target: "%{shared.variables.bai}"
          shared: true
      tooltip: "Run a Minimap2 Alignment against reference FASTA files"
      services:
        - name: minimap2
          label: "Minimap2 Alignment"
          image: "staphb/minimap2"
          workingdir: "/opt/data"
          orchestrated: false #orchestrated means it r
          init: false
          force_restart: false
          force_init: false
          command: ["bash","-c", "minimap2   ${ref} ${file} -a -o ${file}.sam"]
        - name: samtools_view_sam_to_bam_minimap2
          label: "Samtools BAM from SAM"
          image: "staphb/samtools"
          workingdir: "/opt/data"
          orchestrated: false #orchestrated means it r
          init: false
          force_restart: false
          force_init: false
          command: ["bash","-c", "samtools view -S -F4 -b ${sam}  | samtools sort > ${bam}"]
        - name: samtools_index_minimap2
          label: "Samtools Index"
          image: "staphb/samtools"
          workingdir: "/opt/data"
          orchestrated: false #orchestrated means it r
          init: false
          force_restart: false
          force_init: false
          command: ["bash","-c", "samtools index ${bam}"]
            
      