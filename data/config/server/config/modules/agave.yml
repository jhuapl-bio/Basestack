
- name: agave #Top level is the left-hand selection of the menu and the major module to install 
  title: "AGAVE"
  icon: "dna"
  module: True
  init: false 
  version: 1.0
  tags: 
    - "virus"
    - "visualization"
    - "vcf"
    - "variant"
  hint: "View Variant Exploration of vcf calls"
  procedures:
    - name: "agave"
      icon: "dna"
      title: "AGAVE"
      tooltip: "View Variant Exploration of vcf calls"
      dependencies:
        - target: "jhuaplbio/agave"
          label: "jhuaplbio/agave"
          type: "docker"
          format: "docker"
      linking: 
        - output:  #From where to where as input to next procedure
            service: agave_create_report
            target: outputs
            variable: json
          input: 
            service: agave_visualization
            target: variables
            variable: file
      services:
        - name: "agave_create_report"
          label: "Create Report JSON for AGAVE Visualization"
          image: "jhuaplbio/agave"
          workingdir: "/opt/app/AGAVE"
          orchestrated: false
          init: false
          force_restart: false
          force_init: false
          # command: ["bash", "-c", "python3 -m http.server"]
          command: ["bash","-c", "source /opt/conda/etc/profile.d/conda.sh && conda activate AGAVE && python3 controllers/src/vcfs_to_json.py              
            -i ${variant} 
            -o /opt/data/variant/out.json
            --filetype ${filetype}
            -cad ALT_DP 
            -crd REF_DP 
            --gb ${gbs}
            --get_gb ${dir}
            --depth_type 'full'
            --email ${email} 
            --depth ${depth}
            "
          ]
          outputs:
            json:
              watch: True
              label: "JSON file"
              hint: ".json file to be uploaded to the AGAVE visualization Service. "
              type: "file"
              path: ${variant}/out.json
          variables:
            variant: 
              label: "Default.json output"
              hint: "Output file will be in the .json format, to be ingested into the AGAVE visualization"
              options:
                - element: "file"
                  name: "File (single)"
                  bind_parent_dir: true
                  bind: 
                    from: "%{variables.variant.source}"
                    to: "/opt/data/variant"
                  class: "wb-100  p-3 mb-1"
                - element: "dir"
                  name: "Folder"
                  bind_parent_dir: false
                  append:
                    command: "--dir"
                    placement: 2
                  bind: 
                    from: "%{variables.variant.source}"
                    to: "/opt/data/variant"
                  class: "wb-100  p-3 mb-1"
              source: null
            depth: 
              label: "Depth file(s)"
              hint: "One or more files to be used as referencing the depth from the sample run"
              options:
                - element: "file"
                  bind_parent_dir: true
                  bind: 
                    from: "%{variables.depth.source}"
                    to: "/opt/data/depth"
                  class: "wb-100  p-3 mb-1"
                - element: "dir"
                  name: "Folder"
                  bind_parent_dir: false
                  bind: 
                    from: "%{variables.depth.source}"
                    to: "/opt/data/depth"
                  class: "wb-100  p-3 mb-1"
                  append:
                    command: "--dir_depth"
                    placement: 2
            email: 
              label: "Email"
              element: "string"
              source: "brian.merritt@jhuapl.edu"
              target: null
            gbs:
              label: "Genbank Files"
              hint: ".gb files used for referencing sequences"
              # class: "wb-100 p-3 mb-1"
              options:
                - element: null
                  name: "H3n2, nCoV2, H1N1 Default"
                  label: ""
                  target: "/opt/app/AGAVE/data/proteins" 
                - element: "dir"
                  name: "Custom"
                  target: null 
                  bind: 
                    from: "%{variables.gbs.source}"
                    to: "/opt/app/AGAVE/data/proteins" #This ${} is converted into the variable attribute of selected option only!
            filetype:
              label: "Filetype of variant calling pipeline"
              hint: "When variants are generated, they are in the .vcf or .tsv (ivar pipeline) format"
              # class: "wb-100 p-3 mb-1"
              options:
                - element: null
                  name: "vcf"
                  target: "vcf" 
                - element: null
                  name: "tsv"
                  target: "tsv" 
        - name: agave_visualization
          init: true
          hideStatus: true
          label: "AGAVE"
          force_restart: false
          config: null
          image: "jhuaplbio/agave"
          workingdir: "/AGAVE"
          continuous: true
          ports: 
            - 8083:80
          command: ["bash", "-c", "/etc/init.d/nginx restart; cp ${file} /AGAVE/data/default.json;  python3 -m http.server"]
          variables:
            file: 
              element: "file"
              bind_parent_dir: true
              label: "JSON File"
              hint: "Custom JSON generated from the AGAVE report pipeline"
              bind: 
                from: "%{variables.file.source}"
                to: "/data"
            port:
              element: "render"
              column: 12
              port: true
              label: "Rendered Dashboard"
              hint: "Dashboard to display in a web browser"
              suburl: "/AGAVE/"
              bind:
                from: "80"
                to: "8083"
